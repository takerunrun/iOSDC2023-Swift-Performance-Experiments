# iOSDC2023-Swift-Performance-Experiments

## æ¦‚è¦
ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã¯ã€iOSDC Japan 2023ã®ãƒ«ãƒ¼ã‚­ãƒ¼ã‚ºLTã€Œ[Swiftã‚³ãƒ¼ãƒ‰ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ‚ªåŒ– - 6ã¤ã®ã‚±ãƒ¼ã‚¹ã§ã®å®Ÿé¨“çµæœã‚’å ±å‘Š](https://fortee.jp/iosdc-japan-2023/proposal/4b6f4748-7232-474a-800d-fbb09dbeba78)ã€ã§å®Ÿé¨“ã«ç”¨ã„ãŸãƒªãƒã‚¸ãƒˆãƒªã§ã™ï¼

## æ¤œè¨¼ã®ä»•æ–¹

#### ã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„ã€‚å®Ÿé¨“ãŒè¡Œã‚ã‚Œã¾ã™ï¼

```swift
/// PerformanceExperiments/ViewController.swift

class ViewController: UIViewController {

    override func viewDidLoad() {
        super.viewDidLoad()
        // Do any additional setup after loading the view.
    }

    override func viewDidAppear(_ animated: Bool) {
        super.viewDidAppear(animated)
        
        /// å„è¨ˆæ¸¬ã«é–¢ã—ã¦ã€è¤‡æ•°å›å®Ÿè¡Œã—å¹³å‡ã‚’æ±‚ã‚ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã™ã‚‹
        /// Experiments.typeã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ .onlyOnceï¼ˆå„è¨ˆæ¸¬ã«é–¢ã—ã¦ã€1å›ã ã‘è¡Œã†ï¼‰
        // Experiments.type = .multipleTimes
        Experiments.runAll()
    }
}
```

#### `Experiments.type`

- `onlyOnce` ã‚’é¸ã¶ã¨ã€å„è¨ˆæ¸¬ã®é–¢ã—ã¦1å›ã ã‘å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
- `multipleTimes` ã‚’é¸ã¶ã¨ã€å„è¨ˆæ¸¬ã«é–¢ã—ã¦10å›å®Ÿè¡Œã•ã‚Œå¹³å‡å€¤ãŒè¨ˆç®—ã•ã‚Œã¾ã™ã€‚

```swift
extension Experiments {
    enum ExperimentType {
        // å„è¨ˆæ¸¬ã«é–¢ã—ã¦ã€1å›ã ã‘è¡Œã†
        case onlyOnce
        
        // å„è¨ˆæ¸¬ã«é–¢ã—ã¦ã€10å›è¡Œã„ã€å¹³å‡ã‚’å–ã‚‹
        case multipleTimes
    }
}
```


## å®Ÿé¨“çµæœ
ä»¥ä¸‹ã¯ã€`Experiments.type` ã‚’ `.multipleTimes` ã«ã—ã¦ã€å‡ºåŠ›ã•ã‚ŒãŸå®Ÿé¨“çµæœã‹ã‚‰ä¸€éƒ¨ã‚’æŠœç²‹

### å®Ÿé¨“ç’°å¢ƒ
- MacBook Pro 13-inch, M1, 2020
- macOS 13.3.1
- iPhone 14 Simulator
- iOS 16.4



### ã‚±ãƒ¼ã‚¹1 - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®æ¡ä»¶ã«åˆã†æœ€åˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å–å¾—

[ã‚±ãƒ¼ã‚¹1ã®å®Ÿé¨“çµæœã‚’å…¨éƒ¨è¦‹ã‚‹](https://github.com/takerunrun/iOSDC2023-Swift-Performance-Experiments/blob/main/Results/results_case1_multiple_times.md)

```
//===----------------------------------------------------------------------===//
// ã‚±ãƒ¼ã‚¹1 - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®æ¡ä»¶ã«åˆã†æœ€åˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å–å¾—
//===----------------------------------------------------------------------===//

====
// çŠ¶æ³ï¼šå…ˆé ­ã®ãƒªãƒ³ã‚´ãŒã»ã—ã„
let emojis = ["ğŸ‹", "ğŸ‹", "ğŸ", "ğŸ"]

// Bad
let firstApple = emojis.filter { $0 == "ğŸ" }.first

// Good
let firstApple = emojis.first(where: { $0 == "ğŸ" })
====

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒå…¨éƒ¨ãƒªãƒ³ã‚´ã®å ´åˆï¼š[ğŸ, ğŸ, ğŸ, ğŸ]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000001299381 | 0.000000298023 |         4.36 |
       10 | 0.000001895428 | 0.000000202656 |         9.35 |
      100 | 0.000010406971 | 0.000000393391 |        26.45 |
     1000 | 0.000197303295 | 0.000000202656 |       973.59 |
    10000 | 0.000945782661 | 0.000000309944 |      3051.46 |
   100000 | 0.009213793278 | 0.000000393391 |     23421.48 |
  1000000 | 0.086218631268 | 0.000000298023 |    289301.72 |
 10000000 | 0.839765405655 | 0.000000286102 |   2935192.83 |


ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒå…¨éƒ¨ãƒ¬ãƒ¢ãƒ³ã®å ´åˆï¼š[ğŸ‹, ğŸ‹, ğŸ‹, ğŸ‹]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000000607967 | 0.000000298023 |         2.04 |
       10 | 0.000001025200 | 0.000000810623 |         1.26 |
      100 | 0.000008177757 | 0.000008094311 |         1.01 |
     1000 | 0.000080502033 | 0.000079989433 |         1.01 |
    10000 | 0.000800991058 | 0.000802183151 |         1.00 |
   100000 | 0.007992792130 | 0.007992196083 |         1.00 |
  1000000 | 0.080253398418 | 0.080089890957 |         1.00 |
 10000000 | 0.803961229324 | 0.799888205528 |         1.01 |


ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒå‰åŠãƒ¬ãƒ¢ãƒ³ã€å¾ŒåŠãƒªãƒ³ã‚´ã®å ´åˆï¼š[ğŸ‹, ğŸ‹, ğŸ, ğŸ]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000000214577 | 0.000000107288 |         2.00 |
       10 | 0.000001513958 | 0.000000894070 |         1.69 |
      100 | 0.000009012222 | 0.000004184246 |         2.15 |
     1000 | 0.000080192089 | 0.000040054321 |         2.00 |
    10000 | 0.000808167458 | 0.000403213501 |         2.00 |
   100000 | 0.008119797707 | 0.003996479511 |         2.03 |
  1000000 | 0.081247115135 | 0.040334904194 |         2.01 |
 10000000 | 0.814134991169 | 0.401750600338 |         2.03 |
```

### ã‚±ãƒ¼ã‚¹2 - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å­˜åœ¨ç¢ºèª

[ã‚±ãƒ¼ã‚¹2ã®å®Ÿé¨“çµæœã‚’å…¨éƒ¨è¦‹ã‚‹](https://github.com/takerunrun/iOSDC2023-Swift-Performance-Experiments/blob/main/Results/results_case2_multiple_times.md)

```
//===----------------------------------------------------------------------===//
// ã‚±ãƒ¼ã‚¹2 - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å­˜åœ¨ç¢ºèª
//===----------------------------------------------------------------------===//

====
// çŠ¶æ³ï¼šãƒªãƒ³ã‚´ãŒå«ã¾ã‚Œã‚‹ã‹ã©ã†ã‹ã€çŸ¥ã‚ŠãŸã„
let emojis = ["ğŸ‹", "ğŸ‹", "ğŸ", "ğŸ"]

//Bad
let containsApple = !emojis.filter { $0 == "ğŸ" }.isEmpty

//Good
let containsApple = emojis.contains("ğŸ")
====

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒå…¨éƒ¨ãƒªãƒ³ã‚´ã®å ´åˆï¼š[ğŸ, ğŸ, ğŸ, ğŸ]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000001311302 | 0.000000989437 |         1.33 |
       10 | 0.000001811981 | 0.000000202656 |         8.94 |
      100 | 0.000011909008 | 0.000000107288 |       111.00 |
     1000 | 0.000088107586 | 0.000000202656 |       434.76 |
    10000 | 0.000952231884 | 0.000000393391 |      2420.58 |
   100000 | 0.009036517143 | 0.000000202656 |     44590.47 |
  1000000 | 0.084258031845 | 0.000000298023 |    282723.04 |
 10000000 | 0.839069497585 | 0.000000500679 |   1675863.12 |


ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒå…¨éƒ¨ãƒ¬ãƒ¢ãƒ³ã®å ´åˆï¼š[ğŸ‹, ğŸ‹, ğŸ‹, ğŸ‹]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000000596046 | 0.000000202656 |         2.94 |
       10 | 0.000001013279 | 0.000000762939 |         1.33 |
      100 | 0.000007891655 | 0.000007486343 |         1.05 |
     1000 | 0.000078165531 | 0.000072097778 |         1.08 |
    10000 | 0.000796902180 | 0.000721311569 |         1.10 |
   100000 | 0.007997405529 | 0.007344615459 |         1.09 |
  1000000 | 0.080875599384 | 0.072618293762 |         1.11 |
 10000000 | 0.805948412418 | 0.727369177341 |         1.11 |


ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒå‰åŠãƒ¬ãƒ¢ãƒ³ã€å¾ŒåŠãƒªãƒ³ã‚´ã®å ´åˆï¼š[ğŸ‹, ğŸ‹, ğŸ, ğŸ]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000000095367 | 0.000000107288 |         0.89 |
       10 | 0.000001299381 | 0.000000572205 |         2.27 |
      100 | 0.000009119511 | 0.000003993511 |         2.28 |
     1000 | 0.000080800056 | 0.000036287308 |         2.23 |
    10000 | 0.000822687149 | 0.000360798836 |         2.28 |
   100000 | 0.008331298828 | 0.003605306149 |         2.31 |
  1000000 | 0.081529879570 | 0.036142194271 |         2.26 |
 10000000 | 0.819422399998 | 0.362310695648 |         2.26 |
```

### ã‚±ãƒ¼ã‚¹3 - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®å…¨ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ¡ä»¶ã‚’æº€ãŸã™ã“ã¨ã®ç¢ºèª

[ã‚±ãƒ¼ã‚¹3ã®å®Ÿé¨“çµæœã‚’å…¨éƒ¨è¦‹ã‚‹](https://github.com/takerunrun/iOSDC2023-Swift-Performance-Experiments/blob/main/Results/results_case3_multiple_times.md)

```
//===----------------------------------------------------------------------===//
// ã‚±ãƒ¼ã‚¹3 - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®å…¨ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ¡ä»¶ã‚’æº€ãŸã™ã“ã¨ã®ç¢ºèª
//===----------------------------------------------------------------------===//

====
// çŠ¶æ³ï¼šå…¨éƒ¨ãƒªãƒ³ã‚´ã‹ã©ã†ã‹çŸ¥ã‚ŠãŸã„
let emojis = ["ğŸ", "ğŸ", "ğŸ"]

//Bad
let isAllApple = emojis.filter { $0 != "ğŸ" }.isEmpty

//Good
let isAllApple = emojis.allSatisfy { $0 == "ğŸ" }
====

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒå…¨éƒ¨ãƒªãƒ³ã‚´ã®å ´åˆï¼š[ğŸ, ğŸ, ğŸ, ğŸ]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000002300739 | 0.000001013279 |         2.27 |
       10 | 0.000002193451 | 0.000000679493 |         3.23 |
      100 | 0.000009775162 | 0.000006902218 |         1.42 |
     1000 | 0.000077176094 | 0.000068783760 |         1.12 |
    10000 | 0.000761473179 | 0.000673484802 |         1.13 |
   100000 | 0.007487070560 | 0.006473207474 |         1.16 |
  1000000 | 0.070038306713 | 0.064969193935 |         1.08 |
 10000000 | 0.688816702366 | 0.652889680862 |         1.06 |


ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒå…¨éƒ¨ãƒ¬ãƒ¢ãƒ³ã®å ´åˆï¼š[ğŸ‹, ğŸ‹, ğŸ‹, ğŸ‹]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000001001358 | 0.000000309944 |         3.23 |
       10 | 0.000001716614 | 0.000000095367 |        18.00 |
      100 | 0.000011813641 | 0.000000202656 |        58.29 |
     1000 | 0.000102484226 | 0.000000190735 |       537.31 |
    10000 | 0.001023483276 | 0.000000202656 |      5050.35 |
   100000 | 0.010052299500 | 0.000000309944 |     32432.62 |
  1000000 | 0.102523696423 | 0.000000381470 |    268759.72 |
 10000000 | 1.017203295231 | 0.000000405312 |   2509682.26 |


ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒå‰åŠãƒªãƒ³ã‚´ã€å¾ŒåŠãƒ¬ãƒ¢ãƒ³ã®å ´åˆï¼š[ğŸ, ğŸ, ğŸ‹, ğŸ‹]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000000202656 | 0.000000107288 |         1.89 |
       10 | 0.000001382828 | 0.000000298023 |         4.64 |
      100 | 0.000009214878 | 0.000003588200 |         2.57 |
     1000 | 0.000083518028 | 0.000032532215 |         2.57 |
    10000 | 0.000841391087 | 0.000323200226 |         2.60 |
   100000 | 0.008425092697 | 0.003239917755 |         2.60 |
  1000000 | 0.084784424305 | 0.032417082787 |         2.62 |
 10000000 | 0.847915112972 | 0.325056290627 |         2.61 |
```

### ã‚±ãƒ¼ã‚¹4 - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®æœ€å°ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å–å¾—

[ã‚±ãƒ¼ã‚¹4ã®å®Ÿé¨“çµæœã‚’å…¨éƒ¨è¦‹ã‚‹](https://github.com/takerunrun/iOSDC2023-Swift-Performance-Experiments/blob/main/Results/results_case4_multiple_times.md)

```
//===----------------------------------------------------------------------===//
// ã‚±ãƒ¼ã‚¹4 - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®æœ€å°ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å–å¾—
//===----------------------------------------------------------------------===//

====
// çŠ¶æ³ï¼šæœ€å°ã®æ•°å­—ã‚’çŸ¥ã‚ŠãŸã„
let numbers = [0, 1, 2, 3]

//Bad
let minNumber = numbers.sorted().first

//Good
let minNumber = numbers.min()
====

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒ0ã‹ã‚‰æ˜‡é †ã®å ´åˆï¼š[0, 1, 2, 3]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000002515316 | 0.000002300739 |         1.09 |
       10 | 0.000001418591 | 0.000000405312 |         3.50 |
      100 | 0.000010919571 | 0.000008296967 |         1.32 |
     1000 | 0.000084006786 | 0.000063014030 |         1.33 |
    10000 | 0.001071095467 | 0.000609695911 |         1.76 |
   100000 | 0.008440291882 | 0.005161833763 |         1.64 |
  1000000 | 0.079473102093 | 0.052000701427 |         1.53 |
 10000000 | 0.804372191429 | 0.519188094139 |         1.55 |
```

### ã‚±ãƒ¼ã‚¹5 - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒç©ºã‹ã©ã†ã‹ã®ç¢ºèª

[ã‚±ãƒ¼ã‚¹5ã®å®Ÿé¨“çµæœã‚’å…¨éƒ¨è¦‹ã‚‹](https://github.com/takerunrun/iOSDC2023-Swift-Performance-Experiments/blob/main/Results/results_case5_multiple_times.md)

```
//===----------------------------------------------------------------------===//
// ã‚±ãƒ¼ã‚¹5 - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒç©ºã‹ã©ã†ã‹ã®ç¢ºèª
//===----------------------------------------------------------------------===//

====
// çŠ¶æ³ï¼šã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒç©ºã‹ã©ã†ã‹ã€çŸ¥ã‚ŠãŸã„
let emojis = ["ğŸ", "ğŸ", "ğŸ"]

//Bad
let isEmpty = emojis.count == 0

//Good
let isEmpty = emojis.isEmpty
====

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒå…¨éƒ¨ãƒªãƒ³ã‚´ã®å ´åˆï¼š[ğŸ, ğŸ, ğŸ, ğŸ]

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000000095367 | 0.000000703335 |         0.14 |
       10 | 0.000000095367 | 0.000000107288 |         0.89 |
      100 | 0.000000000000 | 0.000000000000 |          nan |
     1000 | 0.000000107288 | 0.000000095367 |         1.12 |
    10000 | 0.000000095367 | 0.000000000000 |          inf |
   100000 | 0.000000095367 | 0.000000000000 |          inf |
  1000000 | 0.000000095367 | 0.000000107288 |         0.89 |
 10000000 | 0.000000000000 | 0.000000000000 |          nan |
```

### ã‚±ãƒ¼ã‚¹6 - æ–‡å­—åˆ—ãŒç©ºæ–‡å­—ã‹ã©ã†ã‹ã®ç¢ºèª

[ã‚±ãƒ¼ã‚¹6ã®å®Ÿé¨“çµæœã‚’å…¨éƒ¨è¦‹ã‚‹](https://github.com/takerunrun/iOSDC2023-Swift-Performance-Experiments/blob/main/Results/results_case6_multiple_times.md)

```
//===----------------------------------------------------------------------===//
// ã‚±ãƒ¼ã‚¹6 - æ–‡å­—åˆ—ãŒç©ºæ–‡å­—ã‹ã©ã†ã‹ã®ç¢ºèª
//===----------------------------------------------------------------------===//

====
// çŠ¶æ³ï¼šæ–‡å­—åˆ—ãŒç©ºã‹ã©ã†ã‹ã€çŸ¥ã‚ŠãŸã„
let string = "iOSDC"

//Bad
let isEmpty = string.count == 0

//Good
let isEmpty = string.isEmpty
====

ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã®å ´åˆï¼šiOSDC

   Size   |      Bad       |      Good      |  Bad / Good  |
-----------------------------------------------------------
        1 | 0.000000286102 | 0.000000298023 |         0.96 |
       10 | 0.000000405312 | 0.000000000000 |          inf |
      100 | 0.000000596046 | 0.000000000000 |          inf |
     1000 | 0.000011110306 | 0.000000095367 |       116.50 |
    10000 | 0.000057411194 | 0.000000000000 |          inf |
   100000 | 0.000555777550 | 0.000000190735 |      2913.87 |
  1000000 | 0.005309009552 | 0.000000000000 |          inf |
 10000000 | 0.051606607437 | 0.000000095367 |    541134.50 |
```